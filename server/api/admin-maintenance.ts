import express, { Request, Response } from 'express';
import { isAdmin } from '../auth';
import fs from 'fs';
import path from 'path';
import util from 'util';
import { exec } from 'child_process';
import { getServerInfo } from '../lib/system-info';
import { clearCachedData } from '../lib/cache-manager';

const router = express.Router();
const execPromise = util.promisify(exec);

/**
 * Ù…Ø³Ø§Ø± Ù„Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
 * ÙŠÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
 */
router.post('/clear-cache', isAdmin, async (req: Request, res: Response) => {
  try {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    await clearCachedData();
    
    console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ù†Ø¬Ø§Ø­');
    res.json({ success: true, message: 'ØªÙ… Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ù†Ø¬Ø§Ø­' });
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª:', error);
    res.status(500).json({ success: false, message: 'ÙØ´Ù„ Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª', error: (error as Error).message });
  }
});

/**
 * Ù…Ø³Ø§Ø± Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
 * ÙŠØ­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
 */
router.post('/purge-uploads', isAdmin, async (req: Request, res: Response) => {
  try {
    // Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ
    const foldersToClean = [
      path.join(process.cwd(), 'uploads', 'temp'),
      path.join(process.cwd(), 'temp')
    ];
    
    // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø­Ø°ÙÙ‡Ø§
    let deletedCount = 0;
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
    for (const folder of foldersToClean) {
      if (fs.existsSync(folder)) {
        const files = fs.readdirSync(folder);
        
        // Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        for (const file of files) {
          const filePath = path.join(folder, file);
          const fileStat = fs.statSync(filePath);
          
          // ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
          if (fileStat.isDirectory()) continue;
          
          // Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ Ù…Ø± Ø¹Ù„Ù‰ Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø§Ø¹ØªÙŠÙ†
          const fileAgeHours = (Date.now() - fileStat.mtimeMs) / (1000 * 60 * 60);
          if (fileAgeHours > 2) {
            fs.unlinkSync(filePath);
            deletedCount++;
          }
        }
      }
    }
    
    console.log(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ ${deletedCount} Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©`);
    res.json({ success: true, message: `ØªÙ… ØªÙ†Ø¸ÙŠÙ ${deletedCount} Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©` });
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©:', error);
    res.status(500).json({ success: false, message: 'ÙØ´Ù„ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©', error: (error as Error).message });
  }
});

/**
 * Ù…Ø³Ø§Ø± Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
 * ÙŠÙ…ÙƒÙ† Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†ÙˆØ¯ Ø¬ÙŠ Ø§Ø³
 */
router.post('/restart-server', isAdmin, async (req: Request, res: Response) => {
  try {
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
    res.json({ success: true, message: 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„Ø£Ù…Ø± Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†ÙŠ...' });
    
    console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…...');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    setTimeout(() => {
      process.exit(0); // Ø³ÙˆÙ ÙŠÙ‚ÙˆÙ… Ù†Ø¸Ø§Ù… Ø±ÙŠØ¨Ù„ÙŠØª Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    }, 1000);
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…:', error);
    res.status(500).json({ success: false, message: 'ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…', error: (error as Error).message });
  }
});

/**
 * Ù…Ø³Ø§Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
 * ÙŠÙ‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø®Ø§Ø¯Ù…
 */
router.get('/system-info', isAdmin, async (req: Request, res: Response) => {
  try {
    // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    const systemInfo = await getServerInfo();
    
    res.json({ success: true, data: systemInfo });
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:', error);
    res.status(500).json({ success: false, message: 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…', error: (error as Error).message });
  }
});

export default router;